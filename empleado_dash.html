<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800" onload="this.rel='stylesheet'" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<title>Stitch Design</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<style>
body {
  min-height: 100dvh;
  font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;
  background-color: #f9fafb;
  color: #1f2937;
}

/* ====== FLUID TEXT ====== */
@layer utilities {
  .text-fluid-2xl { font-size: clamp(1.5rem, 5vw, 1.8rem); }
  .text-fluid-xl  { font-size: clamp(1.25rem, 4vw, 1.5rem); }
  .text-fluid-lg  { font-size: clamp(1.125rem, 3.5vw, 1.15rem); }
  .text-fluid-base{ font-size: clamp(1.2rem, 3vw, 1.5rem); }
  .text-fluid-sm  { font-size: clamp(1rem, 2.5vw, 1.25rem); }
}
</style>
</head>
<body class="bg-gray-50">

<div class="relative flex min-h-screen flex-col justify-between overflow-x-hidden">
  <div class="flex flex-col">
    <!-- HEADER -->
    <header class="flex items-center p-4 pb-2 justify-between sticky top-0 bg-gray-50/80 backdrop-blur-sm z-10">
      <button id="logout-button" class="text-slate-800 flex w-10 h-10 items-center justify-center rounded-full">
        <span class="material-symbols-outlined">logout</span>
      </button>
      <h1 class="text-fluid-2xl text-slate-800 font-bold leading-tight tracking-tight flex-1 text-center">Dashboard</h1>
      <div class="w-10 h-10"></div>
    </header>

    <main class="flex-1 p-4">
      <!-- PERFIL USUARIO -->
      <div class="flex flex-col gap-4 sm:flex-row sm:justify-between sm:items-center">
        <div class="flex items-center gap-4">
          <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-16 h-16 shrink-0" style='background-image: url("https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT8t_9-O-1-cr_Uo_K-mCl-a-H-do-e-a-E-A&s");'></div>
          <div class="flex flex-col">
            <p id="usuario" class="text-fluid-xl font-bold leading-tight tracking-tight text-slate-800">Cargando...</p>
            <p id="id_usuario" class="text-fluid-lg font-normal leading-normal text-slate-500">ID Empleado: ...</p>
          </div>
        </div>
            <div class="flex justify-center p-4">
        <button id="solicitar" class="flex w-full max-w-[480px] cursor-pointer items-center justify-center rounded-lg h-12 px-5 bg-[#F26722] text-white text-fluid-xl font-bold leading-normal tracking-[0.015em] gap-2">
            <span class="material-symbols-outlined">add</span>
            <span>Solicitar horas</span>
        </button>
        </div>
      </div>
     
      <!-- SOLICITUDES -->
      <div class="px-4 pt-5 pb-3 flex justify-between items-center">
        <h2 class="text-fluid-xl font-bold leading-tight tracking-tight text-slate-800">Obras cargadas</h2>
        <a class="text-[#F26722] text-fluid-lg font-bold" href="#">Ver todo</a>
      </div>

      <div id="solicitudes_recientes" class="flex flex-col gap-2 px-4">
        <!-- Solicitudes dinámicas se cargan aquí -->
      </div>
    </main>
  </div>

  <!-- FOOTER -->
  <footer class="sticky bottom-0 bg-white shadow-[0_-1px_3px_rgba(0,0,0,0.05)]">
     
  </footer>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    fetch('/api/user')
        .then(response => response.json())
        .then(data => {
            if(data.nombre && data.id_usuario) {
                document.getElementById('usuario').textContent = data.nombre;
                document.getElementById('id_usuario').textContent = `ID Empleado: ${data.id_usuario}`;
            } else {
                 window.location.href = '/login.html';
            }
        })
        .catch(() => window.location.href = '/login.html');

    fetch('/api/solicitudes')
        .then(response => response.json())
        .then(solicitudes => {
            const container = document.getElementById('solicitudes_recientes');
            container.innerHTML = '';
            if (!solicitudes.length) {
                container.innerHTML = '<p class="text-center text-slate-500">No hay solicitudes recientes.</p>';
                return;
            }
            solicitudes.forEach(solicitud => {
    const statusInfo = getStatusInfo(solicitud.estado);
    const fecha = new Date(solicitud.fecha).toLocaleDateString('es-AR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });

    let horas = 'N/A';
    if (solicitud.horas_solicitadas) {
        const h = solicitud.horas_solicitadas.hours || 0;
        const m = solicitud.horas_solicitadas.minutes || 0;
        horas = `${h}h ${m}m`;
    }

    container.innerHTML += `
      <div class="flex items-center gap-4 bg-white p-3 rounded-lg shadow-sm" data-id="${solicitud.id}">
        <div class="flex items-center justify-center w-10 h-10 ${statusInfo.bgColor} rounded-full">
          <span class="material-symbols-outlined ${statusInfo.textColor}">${statusInfo.icon}</span>
        </div>
        <div class="flex-1">
          <p class="text-fluid-xl font-medium text-slate-800 leading-normal">${solicitud.nombre_obra}</p>
          <p class="text-fluid-lg font-normal text-slate-500 leading-normal">${statusInfo.text}</p>
        </div>
        <div class="shrink-0 text-right">
          <p class="text-fluid-lg font-normal text-slate-500 leading-normal">${fecha}</p>
          <p class="text-fluid-lg font-medium text-slate-800">${horas}</p>
        </div>
        <button class="delete-solicitud text-red-500 hover:text-red-700 ml-2">
          <span class="material-symbols-outlined">delete</span>
        </button>
      </div>
    `;
    });

    // --- Delegated event listener para eliminar ---
    container.addEventListener('click', async (e) => {
        if(e.target.closest('.delete-solicitud')) {
            const card = e.target.closest('[data-id]');
            const id = card.dataset.id;
            if(confirm('¿Desea eliminar esta solicitud?')) {
                try {
                    const res = await fetch(`/api/solicitudes/${id}`, { method: 'DELETE' });
                    const result = await res.json();
                    if(res.ok && result.success) {
                        card.remove();
                        alert('Solicitud eliminada correctamente.');
                    } else {
                        alert(result.message || 'Error eliminando la solicitud.');
                    }
                } catch (err) {
                    console.error(err);
                    alert('No se pudo conectar con el servidor.');
                }
            }
        }
    });

        })
        .catch(error => console.error(error));
});

function getStatusInfo(status) {
    switch (status.toLowerCase()) {
        case 'aprobado': return { icon: 'check', text: 'Aprobado', bgColor: 'bg-emerald-100', textColor: 'text-emerald-600' };
        case 'rechazado': return { icon: 'close', text: 'Rechazado', bgColor: 'bg-red-100', textColor: 'text-red-600' };
        default: return { icon: 'pending', text: 'Pendiente', bgColor: 'bg-yellow-100', textColor: 'text-yellow-600' };
    }
}

document.getElementById('solicitar').addEventListener('click', () => {
    window.location.href = '/solicitar';
});

document.getElementById('logout-button').addEventListener('click', async () => {
    try {
        const response = await fetch('/logout', { method: 'POST' });
        const result = await response.json();
        if (result.success) window.location.href = '/login.html';
    } catch (error) {
        console.error(error);
    }
});
</script>

</body>
</html>
